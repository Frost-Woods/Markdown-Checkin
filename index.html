<!DOCTYPE html>
<html lang="zh-CN" class="light-mode">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown打卡平台（GitHub直连版）</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simplemde@1.11.2/dist/simplemde.min.css">
    <!-- 增强版Prism高亮主题 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-vs.min.css">
    <style>
        /* 基础布局 */
        html, body { 
            padding: 0;
            margin: 0;
            transition: background-color 0.3s, color 0.3s;
            min-height: 100vh;
        }
        .app-container {
            display: flex;
            min-height: 100vh;
            width: 100%;
        }

        /* 侧边栏样式 */
        .sidebar {
            width: 300px;
            background-color: #f8f9fa;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            position: relative;
            min-height: 100vh;
            z-index: 10;
            color: #333;
        }
        .sidebar.collapsed {
            width: 60px;
            padding: 0;
            overflow: hidden;
        }
        .sidebar-toggle {
            position: absolute;
            right: 15px;
            top: 20px;
            background-color: transparent;
            border: none;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            transition: color 0.3s;
        }
        .sidebar-toggle .hamburger {
            display: block;
            width: 20px;
            height: 2px;
            background-color: currentColor;
            position: relative;
        }
        .sidebar-toggle .hamburger::before,
        .sidebar-toggle .hamburger::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 2px;
            background-color: currentColor;
            left: 0;
        }
        .sidebar-toggle .hamburger::before {
            top: -6px;
        }
        .sidebar-toggle .hamburger::after {
            top: 6px;
        }
        .sidebar.collapsed .sidebar-toggle .hamburger {
            transform: rotate(90deg);
        }

        /* 主内容区 */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }

        /* 文件项样式 */
        .file-item { 
            cursor: pointer; 
            padding: 8px; 
            border: 1px solid #eee; 
            margin-bottom: 5px; 
            border-radius: 4px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            transition: background-color 0.3s, border-color 0.3s;
        }
        .file-item:hover { 
            background-color: #f5f5f5; 
        }
        .delete-btn { 
            padding: 2px 8px; 
            font-size: 12px; 
        }

        /* 预览区样式 */
        #preview { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            line-height: 1.6; 
            min-height: 400px; 
            padding: 1rem;
            border-radius: 4px;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
            border: 1px solid #eee;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        #preview h1, #preview h2, #preview h3 { 
            border-bottom: 1px solid #eee; 
            padding-bottom: 0.5rem; 
            margin-top: 1rem; 
            transition: border-color 0.3s;
        }
        /* 增强代码块高亮样式 */
        #preview code { 
            padding: 2px 4px; 
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
        }
        #preview pre { 
            padding: 1.5rem;
            border-radius: 8px;
            overflow-x: auto;
            border: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 1rem 0;
        }
        #preview img { 
            max-width: 100%; 
            height: auto; 
        }

        /* 明暗模式切换按钮（改为文字样式） */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #0d6efd;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
            z-index: 100;
            font-size: 14px;
        }

        /* 【新增：代码块语言选择下拉按钮样式】 */
        .CodeMirror .editor-toolbar .dropdown {
            position: relative;
            display: inline-block;
        }
        .CodeMirror .editor-toolbar .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            z-index: 1000;
            display: none;
            float: left;
            min-width: 120px;
            padding: 5px 0;
            margin: 2px 0 0;
            font-size: 14px;
            text-align: left;
            list-style: none;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 6px 12px rgba(0,0,0,0.175);
        }
        .dark-mode .CodeMirror .editor-toolbar .dropdown-menu {
            background-color: #2d2d2d;
            border-color: #444;
            color: #e0e0e0;
        }
        .CodeMirror .editor-toolbar .dropdown-menu li {
            padding: 3px 20px;
            cursor: pointer;
        }
        .CodeMirror .editor-toolbar .dropdown-menu li:hover {
            background-color: #f5f5f5;
        }
        .dark-mode .CodeMirror .editor-toolbar .dropdown-menu li:hover {
            background-color: #3d3d3d;
        }
        .CodeMirror .editor-toolbar .dropdown:hover .dropdown-menu {
            display: block;
        }

        /* 明亮模式样式 */
        .light-mode {
            background-color: #ffffff;
            color: #333333;
        }
        .light-mode .sidebar {
            background-color: #f8f9fa;
            color: #333;
        }
        .light-mode .main-content {
            background-color: #ffffff;
            color: #333;
        }
        .light-mode .file-item {
            border-color: #eee;
            color: #333;
        }
        .light-mode .file-item:hover {
            background-color: #f5f5f5;
        }
        .light-mode #preview {
            background-color: #f8f9fa;
            color: #333;
            border-color: #eee;
        }
        .light-mode #preview h1, .light-mode #preview h2, .light-mode #preview h3 {
            border-bottom-color: #eee;
        }
        .light-mode #preview code {
            background-color: #f0f0f0;
            color: #d63384;
        }
        .light-mode #preview pre {
            background-color: #f8f9fa;
            color: #333;
        }
        .light-mode input, .light-mode textarea, .light-mode .form-control {
            background-color: #ffffff;
            color: #333;
            border-color: #ddd;
        }
        .light-mode #file-upload {
            background-color: #ffffff;
            color: #333;
            border-color: #ddd;
        }
        .light-mode .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border-color: #bee5eb;
        }
        /* SimpleMDE编辑器明亮模式 */
        .light-mode .simplemde {
            background-color: #ffffff;
            border-color: #ddd;
        }
        .light-mode .simplemde .editor-toolbar {
            background-color: #f8f9fa;
            border-bottom-color: #ddd;
        }
        .light-mode .simplemde .CodeMirror {
            background-color: #ffffff;
            color: #333;
            border-color: #ddd;
        }
        .light-mode .simplemde .CodeMirror-gutter {
            background-color: #f8f9fa;
            border-right-color: #ddd;
        }

        /* 暗色模式样式（核心修复编辑框） */
        .dark-mode {
            background-color: #1a1a1a;
            color: #e0e0e0;
        }
        .dark-mode .sidebar {
            background-color: #2d2d2d;
            color: #e0e0e0;
        }
        .dark-mode .sidebar-toggle {
            color: #e0e0e0;
        }
        .dark-mode .main-content {
            background-color: #1a1a1a;
            color: #e0e0e0;
        }
        .dark-mode .file-item {
            border-color: #666;
            color: #e0e0e0;
        }
        .dark-mode .file-item:hover {
            background-color: #3d3d3d;
        }
        .dark-mode #preview {
            background-color: #2d2d2d;
            color: #e0e0e0;
            border-color: #666;
        }
        .dark-mode #preview h1, .dark-mode #preview h2, .dark-mode #preview h3 {
            border-bottom-color: #666;
        }
        .dark-mode #preview code {
            background-color: #444;
            color: #c9d1d9;
        }
        .dark-mode #preview pre {
            background-color: #252525;
            color: #e0e0e0;
        }
        .dark-mode input, .dark-mode textarea, .dark-mode .form-control {
            background-color: #3d3d3d;
            color: #e0e0e0;
            border-color: #666;
        }
        .dark-mode #file-upload {
            background-color: #3d3d3d;
            color: #e0e0e0;
            border-color: #666;
        }
        /* SimpleMDE编辑器暗色模式（完整覆盖） */
        .dark-mode .simplemde {
            background-color: #3d3d3d;
            border-color: #666;
        }
        .dark-mode .simplemde .editor-toolbar {
            background-color: #2d2d2d;
            border-bottom-color: #666;
        }
        .dark-mode .simplemde .editor-toolbar button {
            color: #e0e0e0;
        }
        .dark-mode .simplemde .editor-toolbar button:hover {
            color: #ffffff;
        }
        .dark-mode .simplemde .CodeMirror {
            background-color: #3d3d3d;
            color: #e0e0e0;
            border-color: #666;
        }
        .dark-mode .simplemde .CodeMirror-gutter {
            background-color: #2d2d2d;
            border-right-color: #666;
        }
        .dark-mode .simplemde .CodeMirror-lines {
            color: #e0e0e0;
        }
        .dark-mode .alert-info {
            background-color: #2d3b45;
            color: #e0e0e0;
            border-color: #445a6b;
        }
    </style>
    <!-- 音效 -->
    <audio id="error-audio" preload="auto">
        <source src="./static/error.mp3" type="audio/mpeg">
        <source src="https://cdn.jsdelivr.net/gh/fawazahmed0/simple-api@main/audio/you-gan-ma-ai-yo.mp3" type="audio/mpeg">
    </audio>
    <audio id="success-audio" preload="auto">
        <source src="./static/success.mp3" type="audio/mpeg">
        <source src="https://cdn.jsdelivr.net/gh/fawazahmed0/simple-api@main/audio/wa-zhen-de-shi-ni-ya.mp3" type="audio/mpeg">
    </audio>
</head>
<body>
    <!-- 主题切换按钮（改为文字） -->
    <button class="theme-toggle" id="theme-toggle">切换到深色模式</button>

    <div class="app-container">
        <!-- 侧边栏（配置区） -->
        <div class="sidebar" id="sidebar">
            <button class="sidebar-toggle" id="sidebar-toggle">
                <span class="hamburger"></span>
            </button>
            <div class="alert alert-info p-3" style="margin-top: 60px;">
                <h5>GitHub配置</h5>
                <div class="mb-2">
                    <label>用户名：</label>
                    <input type="text" id="github-user" class="form-control mt-1" placeholder="如：Frost-Woods" value="你的用户名">
                </div>
                <div class="mb-2">
                    <label>仓库名：</label>
                    <input type="text" id="github-repo" class="form-control mt-1" placeholder="如：Markdown-Checkin" value="你的仓库名">
                </div>
                <div class="mb-2">
                    <label>PAT（repo权限）：</label>
                    <input type="password" id="github-token" class="form-control mt-1" placeholder="ghp_xxxx" value="你的PAT">
                </div>
                <div class="mb-2">
                    <label>分支名：</label>
                    <input type="text" id="github-branch" class="form-control mt-1" placeholder="main" value="main">
                </div>
            </div>
        </div>

        <!-- 主内容区 -->
        <div class="main-content">
            <h1>Markdown打卡平台</h1>

            <!-- 上传区 -->
            <div class="upload-area mt-4">
                <h4>上传打卡文件</h4>
                <input type="file" id="file-upload" accept=".md" class="form-control mt-2">
                <button id="upload-btn" class="btn btn-primary mt-2">上传文件</button>
                <div id="upload-status" class="mt-2 text-success"></div>
            </div>

            <!-- 文件列表 -->
            <div class="file-list-area mt-4">
                <h4>已上传的打卡文件</h4>
                <div id="file-list" class="file-list"></div>
            </div>

            <!-- 编辑+预览 -->
            <div class="editor-container mt-4">
                <h4>编辑打卡内容</h4>
                <div class="row mt-2">
                    <div class="col-md-6">
                        <textarea id="editor"></textarea>
                        <div class="mt-3">
                            <button id="save-btn" class="btn btn-success">保存修改</button>
                            <button id="export-btn" class="btn btn-info export-btn" disabled>导出文件</button>
                            <div id="save-status" class="mt-2 text-success"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5 class="mb-2">实时预览</h5>
                        <div id="preview" class="border"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/simplemde@1.11.2/dist/simplemde.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.0/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
    <!-- 加载更多代码语言的高亮组件 -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-html.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-css.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-java.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-cpp.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-go.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-rust.min.js"></script>

    <script>
        // 【核心新增：代码块语言选择工具函数】
        function insertCodeBlock(lang) {
            const simplemde = window.simplemdeInstance;
            const cursor = simplemde.codemirror.getCursor();
            const selectedText = simplemde.codemirror.getSelection();
            
            // 代码块模板：保留选中内容，光标定位到代码块内部
            const codeBlock = `\n\`\`\`${lang}\n${selectedText || ''}\n\`\`\`\n`;
            simplemde.codemirror.replaceSelection(codeBlock);
            
            // 将光标移动到代码块内部
            if (!selectedText) {
                const newCursor = {
                    line: cursor.line + 2,
                    ch: 0
                };
                simplemde.codemirror.setCursor(newCursor);
            }
            
            // 触发预览更新
            simplemde.codemirror.focus();
            simplemde.codemirror.trigger('change');
        }

        // 初始化编辑器（新增代码块语言选择按钮）
        const simplemde = new SimpleMDE({
            element: document.getElementById("editor"),
            autofocus: false,
            spellChecker: false,
            toolbar: [
                "bold", "italic", "heading", "|", 
                "unordered-list", "ordered-list", "|", 
                "link", "image", "|",
                // 【新增：代码块语言选择下拉按钮】
                {
                    name: "code-block",
                    className: "dropdown",
                    title: "插入代码块",
                    innerHTML: `
                        <button type="button" class="btn btn-sm">代码块 ▼</button>
                        <ul class="dropdown-menu">
                            <li onclick="insertCodeBlock('text')">纯文本</li>
                            <li onclick="insertCodeBlock('javascript')">JavaScript</li>
                            <li onclick="insertCodeBlock('python')">Python</li>
                            <li onclick="insertCodeBlock('html')">HTML</li>
                            <li onclick="insertCodeBlock('css')">CSS</li>
                            <li onclick="insertCodeBlock('java')">Java</li>
                            <li onclick="insertCodeBlock('cpp')">C++</li>
                            <li onclick="insertCodeBlock('go')">Go</li>
                            <li onclick="insertCodeBlock('rust')">Rust</li>
                        </ul>
                    `
                },
                "|", "preview", "fullscreen"
            ]
        });
        // 挂载到全局，方便工具函数调用
        window.simplemdeInstance = simplemde;

        // 实时预览（集成代码高亮）
        simplemde.codemirror.on("change", function() {
            const content = simplemde.value();
            marked.setOptions({
                highlight: function(code, lang) {
                    // 确保代码块完整解析（兼容无语言标识的情况）
                    if (!lang) lang = 'text';
                    if (Prism.languages[lang]) {
                        return Prism.highlight(code, Prism.languages[lang], lang);
                    }
                    return code;
                },
                breaks: true
            });
            // 修复代码块断层（强制保留原始换行）
            const parsedContent = marked.parse(content.replace(/\n/g, '\n'));
            document.getElementById("preview").innerHTML = parsedContent || "<p class='text-muted'>编辑Markdown内容，这里实时预览～</p>";
        });

        // 全局变量
        let currentFile = { name: "", sha: "" };
        let GITHUB_CONFIG = {
            user: "",
            repo: "",
            token: "",
            branch: ""
        };

        // 读取配置
        function getConfig() {
            GITHUB_CONFIG = {
                user: $("#github-user").val().trim(),
                repo: $("#github-repo").val().trim(),
                token: $("#github-token").val().trim(),
                branch: $("#github-branch").val().trim() || "main"
            };
            if (!GITHUB_CONFIG.user || !GITHUB_CONFIG.repo || !GITHUB_CONFIG.token) {
                alert("请先填写完整的GitHub配置！");
                return false;
            }
            return true;
        }

        // 请求头
        function getHeaders() {
            return {
                "Authorization": `token ${GITHUB_CONFIG.token}`,
                "Accept": "application/vnd.github.v3+json",
                "Content-Type": "application/json"
            };
        }

        // 播放音效
        function playAudio(audioId) {
            const audio = document.getElementById(audioId);
            audio.pause();
            audio.currentTime = 0;
            audio.play().catch(() => {
                alert(audioId === "error-audio" ? "你干嘛哎哟！只能上传.md文件～" : "哇真的是你呀！格式正确～");
            });
        }

        // 加载文件列表
        function loadFileList() {
            if (!getConfig()) return;

            const apiUrl = `https://api.github.com/repos/${GITHUB_CONFIG.user}/${GITHUB_CONFIG.repo}/contents/?ref=${GITHUB_CONFIG.branch}`;
            $("#file-list").html("<div class='text-muted'>加载中...</div>");

            $.get({
                url: apiUrl,
                headers: getHeaders(),
                success: function(data) {
                    const fileList = $("#file-list");
                    fileList.empty();
                    const mdFiles = data.filter(item => item.type === "file" && item.name.endsWith(".md"));

                    if (mdFiles.length === 0) {
                        fileList.html("<div class='text-muted'>暂无.md文件</div>");
                        return;
                    }

                    mdFiles.forEach(file => {
                        const commitUrl = `https://api.github.com/repos/${GITHUB_CONFIG.user}/${GITHUB_CONFIG.repo}/commits?path=${encodeURIComponent(file.name)}&per_page=1&ref=${GITHUB_CONFIG.branch}`;
                        $.get({
                            url: commitUrl,
                            headers: getHeaders(),
                            success: function(commits) {
                                const updateTime = commits.length > 0 ? new Date(commits[0].commit.committer.date).toLocaleString() : "未知时间";
                                const fileItem = $(`<div class='file-item'>
                                    <div>${file.name} <small class='text-muted'>(${updateTime})</small></div>
                                    <button class='btn btn-danger btn-sm delete-btn' data-filename='${file.name}' data-sha='${file.sha}'>删除</button>
                                </div>`);

                                fileItem.find("div:first").click(function() {
                                    const filename = $(this).parent().find(".delete-btn").data("filename");
                                    loadFileContent(filename);
                                });

                                fileItem.find(".delete-btn").click(function(e) {
                                    e.stopPropagation();
                                    const filename = $(this).data("filename");
                                    const sha = $(this).data("sha");
                                    if (confirm(`确定删除 ${filename} 吗？无法恢复！`)) {
                                        deleteFile(filename, sha);
                                    }
                                });

                                fileList.append(fileItem);
                            }
                        });
                    });
                },
                error: function(err) {
                    $("#file-list").html(`<div class='text-danger'>加载失败：${err.responseJSON?.message || "未知错误"}</div>`);
                }
            });
        }

        // 加载文件内容（UTF-8兼容）
        function loadFileContent(filename) {
            if (!getConfig()) return;
            
            const apiUrl = `https://api.github.com/repos/${GITHUB_CONFIG.user}/${GITHUB_CONFIG.repo}/contents/${encodeURIComponent(filename)}?ref=${GITHUB_CONFIG.branch}`;
            $.get({
                url: apiUrl,
                headers: getHeaders(),
                success: function(data) {
                    const binaryStr = atob(data.content.replace(/\n/g, ""));
                    let utf8Str = "";
                    for (let i = 0; i < binaryStr.length; i++) {
                        utf8Str += String.fromCharCode(binaryStr.charCodeAt(i));
                    }
                    const content = decodeURIComponent(escape(utf8Str));
                    
                    simplemde.value(content);
                    currentFile = { name: filename, sha: data.sha };
                    $("#export-btn").prop("disabled", false);
                    $("#save-status").text("");
                },
                error: function(err) {
                    alert(`加载失败：${err.responseJSON?.message}`);
                }
            });
        }

        // 上传文件
        $("#upload-btn").click(function() {
            const fileInput = $("#file-upload")[0];
            if (!fileInput.files.length) {
                alert("请选择文件！");
                return;
            }
            if (!getConfig()) return;

            const file = fileInput.files[0];
            if (!file.name.endsWith(".md")) {
                playAudio("error-audio");
                $("#upload-status").text("只能上传.md文件！").removeClass("text-success").addClass("text-danger");
                return;
            }

            playAudio("success-audio");
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = btoa(e.target.result);
                const apiUrl = `https://api.github.com/repos/${GITHUB_CONFIG.user}/${GITHUB_CONFIG.repo}/contents/${encodeURIComponent(file.name)}?ref=${GITHUB_CONFIG.branch}`;
                $("#upload-status").text("上传中...").removeClass("text-danger").addClass("text-success");

                $.ajax({
                    url: apiUrl,
                    type: "PUT",
                    headers: getHeaders(),
                    data: JSON.stringify({
                        message: `Upload ${file.name} - ${new Date().toLocaleString()}`,
                        content: content,
                        branch: GITHUB_CONFIG.branch
                    }),
                    success: function() {
                        $("#upload-status").text("上传成功！");
                        loadFileList();
                        fileInput.value = "";
                        setTimeout(() => $("#upload-status").text(""), 3000);
                    },
                    error: function(err) {
                        $("#upload-status").text(`失败：${err.responseJSON?.message}`).removeClass("text-success").addClass("text-danger");
                    }
                });
            };
            reader.readAsText(file);
        });

        // 保存文件
        $("#save-btn").click(function() {
            if (!currentFile.name) {
                alert("请先选择文件！");
                return;
            }
            if (!getConfig()) return;

            const content = simplemde.value();
            const apiUrl = `https://api.github.com/repos/${GITHUB_CONFIG.user}/${GITHUB_CONFIG.repo}/contents/${encodeURIComponent(currentFile.name)}?ref=${GITHUB_CONFIG.branch}`;
            $("#save-status").text("保存中...");

            $.get({
                url: apiUrl,
                headers: getHeaders(),
                success: function(fileData) {
                    $.ajax({
                        url: apiUrl,
                        type: "PUT",
                        headers: getHeaders(),
                        data: JSON.stringify({
                            message: `Update ${currentFile.name} - ${new Date().toLocaleString()}`,
                            content: btoa(unescape(encodeURIComponent(content))),
                            sha: fileData.sha,
                            branch: GITHUB_CONFIG.branch
                        }),
                        success: function() {
                            $("#save-status").text("保存成功！");
                            loadFileList();
                            setTimeout(() => $("#save-status").text(""), 3000);
                        },
                        error: function(err) {
                            if (err.status === 409) {
                                $("#save-status").text("版本冲突！请重新加载文件～").addClass("text-danger");
                            } else {
                                $("#save-status").text(`失败：${err.responseJSON?.message}`).addClass("text-danger");
                            }
                        }
                    });
                }
            });
        });

        // 删除文件
        function deleteFile(filename, sha) {
            if (!getConfig()) return;

            const apiUrl = `https://api.github.com/repos/${GITHUB_CONFIG.user}/${GITHUB_CONFIG.repo}/contents/${encodeURIComponent(filename)}?ref=${GITHUB_CONFIG.branch}`;
            $.ajax({
                url: apiUrl,
                type: "DELETE",
                headers: getHeaders(),
                data: JSON.stringify({
                    message: `Delete ${filename} - ${new Date().toLocaleString()}`,
                    sha: sha,
                    branch: GITHUB_CONFIG.branch
                }),
                success: function() {
                    alert(`删除 ${filename} 成功！`);
                    loadFileList();
                    if (currentFile.name === filename) {
                        simplemde.value("");
                        currentFile = { name: "", sha: "" };
                        $("#export-btn").prop("disabled", true);
                    }
                },
                error: function(err) {
                    alert(`删除失败：${err.responseJSON?.message}`);
                }
            });
        }

        // 导出文件
        $("#export-btn").click(function() {
            if (!currentFile.name) {
                alert("请先选择文件！");
                return;
            }
            const content = simplemde.value();
            const blob = new Blob([content], { type: "text/markdown" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = currentFile.name;
            a.click();
            URL.revokeObjectURL(url);
        });

        // 侧边栏切换
        $("#sidebar-toggle").click(function() {
            const sidebar = $("#sidebar");
            if (sidebar.hasClass("collapsed")) {
                sidebar.removeClass("collapsed");
            } else {
                sidebar.addClass("collapsed");
            }
        });

        // 明暗模式切换（改为文字按钮）
        $("#theme-toggle").click(function() {
            const html = document.documentElement;
            const toggleBtn = $(this);
            if (html.classList.contains("light-mode")) {
                html.classList.remove("light-mode");
                html.classList.add("dark-mode");
                toggleBtn.text("切换到浅色模式");
            } else {
                html.classList.remove("dark-mode");
                html.classList.add("light-mode");
                toggleBtn.text("切换到深色模式");
            }
        });

        // 页面加载初始化
        $(document).ready(function() {
            loadFileList();
            document.getElementById("preview").innerHTML = "<p class='text-muted'>编辑Markdown内容，这里实时预览～</p>";
            $("#github-user, #github-repo, #github-token, #github-branch").change(loadFileList);
        });
    </script>
</body>
</html>
